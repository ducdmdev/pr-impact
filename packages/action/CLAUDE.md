# CLAUDE.md -- @pr-impact/action

## What this package does

GitHub Action that runs an agentic Claude loop to analyze PRs. Reads inputs from `action.yml`, calls the Anthropic API with tool definitions, and produces a structured risk report. Optionally posts the report as a PR comment.

## Quick commands

```bash
pnpm build --filter=@pr-impact/action   # Prebuild (embed templates) + tsup (CJS bundle)
npx vitest run packages/action           # Run tests
```

## Source layout

```
src/
  index.ts                 -- Entry point: reads inputs, runs analysis, sets outputs, posts comment
  client.ts                -- runAnalysis(): Anthropic API agentic loop (30 iterations, 180s timeout, temperature 0)
  tools.ts                 -- executeTool(): dispatches tool_use calls to tools-core functions
  comment.ts               -- postOrUpdateComment(): upsert PR comment via GitHub API with HTML markers
  generated/
    templates.ts           -- AUTO-GENERATED by scripts/embed-templates.ts (do not edit)
```

## Key patterns

- **CJS output**: builds to `dist/index.cjs` because GitHub Actions requires CommonJS. All dependencies are bundled (`noExternal: [/.*/]`).
- **Prebuild step**: `scripts/embed-templates.ts` generates `src/generated/templates.ts` from `templates/*.md` before tsup runs.
- **Tool input cloning**: `client.ts` clones `toolUse.input` via spread to avoid mutating the conversation history.
- **Parallel tool execution**: multiple tool_use blocks in a single response are executed concurrently via `Promise.all`.
- **Risk score parsing**: regex extracts score from report. If parsing fails, sets score to `-1` and level to `unknown` instead of failing.
- **Comment upsert**: uses `<!-- pr-impact:start -->` / `<!-- pr-impact:end -->` HTML markers to find and update existing comments.

## Testing

Tests in `__tests__/` mock `@actions/core`, `@actions/github`, the Anthropic SDK, and tools-core functions. The entry point test uses `vi.resetModules()` + `vi.doMock()` to re-trigger the top-level `main()` call on each import.

<!-- c3-generated: c3-301,c3-310,c3-311,c3-312,c3-313 -->
## Architecture docs

Before modifying this code, read:
- Container: `.c3/c3-3-action/README.md`
- Components:
  - `.c3/c3-3-action/c3-301-template-embedding.md`
  - `.c3/c3-3-action/c3-310-agentic-client.md`
  - `.c3/c3-3-action/c3-311-tool-dispatcher.md`
  - `.c3/c3-3-action/c3-312-comment-poster.md`
  - `.c3/c3-3-action/c3-313-action-entrypoint.md`
- Patterns: `ref-build-pipeline`

Full refs: `.c3/refs/ref-{name}.md`
<!-- end-c3-generated -->
